# Gemini API テスト仕様書

## 概要
- 対象: `src/llm/gemini/geminiApi.ts`
- 目的: `GeminiProvider`のエラーハンドリング能力を検証する

---

## テストケース一覧

| No. | テスト内容                               | 目的                                           |
|-----|------------------------------------------|------------------------------------------------|
| 1   | fetch失敗時にフォールバックを返す        | `safeFetch`の失敗時にフォールバックメッセージを返すか |
| 2   | 候補テキスト欠落時にフォールバックを返す | APIレスポンスにテキストが含まれない場合にフォールバックするか |
| 3   | 候補テキストが利用可能な場合にテキストを返す | APIレスポンスが正常な場合にテキストを正しく抽出して返すか |

---

## 各テストケース詳細

### 1. fetch失敗時にフォールバックを返す
- **テスト対象**: `GeminiProvider.generateReply`
- **目的**: 内部の`safeFetch`呼び出しが失敗した場合に、`GeminiProvider`がフォールバックのエラーメッセージを返すことを検証する
- **前提条件**:
  - `safeFetch`ユーティリティがエラー（例：ネットワークエラー）でリジェクトされるようにモック化
  - `debugLog`ユーティリティをスパイして呼び出しを監視
- **入力値・操作**:
  - `GeminiProvider.generateReply`をサンプルプロンプトとAPIキーで呼び出す
- **期待結果**:
  - 関数が日本語のフォールバックメッセージ「リプライ生成に失敗しました」を返す
  - `debugLog`関数がエラー詳細をログに記録するために呼び出される

### 2. 候補テキスト欠落時にフォールバックを返す
- **テスト対象**: `GeminiProvider.generateReply`
- **目的**: APIレスポンスは成功したものの、期待される候補テキストが含まれていない場合に、プロバイダがフォールバックメッセージを返すことを確認する
- **前提条件**:
  - `safeFetch`が、`candidates`配列や必要なネストされたプロパティが欠けたJSONオブジェクトで解決されるようにモック化
  - `debugLog`ユーティリティをモック化
- **入力値・操作**:
  - `GeminiProvider.generateReply`を呼び出す
- **期待結果**:
  - 関数がフォールバックメッセージ「リプライ生成に失敗しました」を返す
  - `debugLog`関数が呼び出される

### 3. 候補テキストが利用可能な場合にテキストを返す
- **テスト対象**: `GeminiProvider.generateReply`
- **目的**: APIレスポンスが有効な場合に、プロバイダが生成されたテキストを正しく抽出して返すことを検証する
- **前提条件**:
  - `safeFetch`が、テキスト「ok」を含む候補を持つ有効なGemini APIのJSONレスポンスで解決されるようにモック化
- **入力値・操作**:
  - `GeminiProvider.generateReply`を呼び出す
- **期待結果**:
  - 関数が文字列「ok」を返す

</rewritten_file> 